import{_ as t,R as e,s as n,T as s,U as o,V as a,Y as i,Z as c,a0 as h,a1 as l,a2 as d,r,c as u,i as p,w as m,H as f,d as g,q as y,a3 as x,a4 as _,o as S,g as C,k,t as w}from"./index-FwbBwjbJ.js";const I=t({data:()=>({captcha:"",phone:null,showPhone:"",smsKey:null,canSend:!1,codeText:"",limitSeconds:120}),onLoad(t){const e=this.getOpenerEventChannel();let n=this;e.on("smsInfo",(function(t){n.configSMSData(t)}))},methods:{goBack(){e()},configSMSData(t){const e=JSON.parse(t.data);this.phone=e.phone,this.showPhone=this.encryptPhoneCustom(this.phone),this.smsKey=e.smsKey,this.phone&&this.smsKey?this.$refs.uCode.start():this.canSend=!1},finish(t){this.captcha=t,this.phone&&this.smsKey?this.apiToLogin():n({title:"未获取到手机号",icon:"none"})},codeChange(t){this.codeText=t},encryptPhoneCustom(t,e=3,n=4){const s=String(t).trim();if(!/^1\d{10}$/.test(s))return"无效号码";const o="*".repeat(s.length-e-n);return s.slice(0,e)+o+s.slice(-n)},codeEnd(){this.canSend=!0},getSMSCode(){this.phone?(s({title:"正在发送...",mask:!0}),o(this.phone).then((t=>{t.data.code&&(a(),n({icon:"none",title:"验证码已发送"}),this.canSend=!1,this.$refs.uCode.start(),this.smsKey=t.data.code)})).catch((t=>{a(),n({icon:"error",title:"发送失败"})}))):n({title:"未获取到手机号",icon:"none"})},async apiToLogin(){if(0==this.smsKey.length)return void n({title:"请获取验证码",icon:"none"});const t={phone:this.phone,code:this.captcha,grant_type:"phone_sms_smart",scope:"all"};s({title:"正在登录...",mask:!0});var e=null;try{const n=(await i(this.phone)).data;for(var o=0;o<n.length;o++){if("781155"==n[o].tenantId){e="781155";break}}!e&&n.length>0&&(e=n[0].tenantId),e&&(t.tenantId=e)}catch(d){return void uni.$u.toast("网络请求失败")}c(t,this.smsKey).then((t=>{t.tenantInfoList&&t.tenantInfoList.length>1?this.switchTenant(t):t.access_token?(h.commit("login",t),a(),n({icon:"none",title:"登录成功"}),l({url:"/pages/index/index"})):t.msg?(a(),n({icon:"error",title:t.msg})):uni.$u.toast("登录失败")})).catch((t=>{a(),n({icon:"error",title:"登录失败"})}))},switchTenant(t){const e=t.tenantInfoList[1].tenantId,s=t.refresh_token;d(e,s).then((t=>{h.commit("login",t),a(),n({icon:"none",title:"登录成功"}),l({url:"/pages/index/index"})})).catch((t=>{a(),n({icon:"error",title:"登录失败"})}))}}},[["render",function(t,e,n,s,o,a){const i=r(u("u-status-bar"),f),c=r(u("u-icon"),g),h=y,l=r(u("u-code-input"),x),d=r(u("u-code"),_);return S(),p(h,null,{default:m((()=>[C(h,null,{default:m((()=>[C(i),C(h,{class:"u-flex-y-center u-p-l-30",style:{width:"200rpx",height:"100rpx"},onClick:a.goBack},{default:m((()=>[C(c,{name:"close",color:"#292A2B",size:"20"})])),_:1},8,["onClick"])])),_:1}),C(h,{class:"u-m-t-30 u-margin-center-auto",style:{width:"600rpx"}},{default:m((()=>[C(h,{class:"l-title"},{default:m((()=>[k("输入验证码")])),_:1}),C(h,{class:"u-m-t-12",style:{color:"#666e81","font-size":"24rpx"}},{default:m((()=>[k("短信已发送至+86"+w(o.showPhone),1)])),_:1}),C(l,{class:"u-m-t-80",modelValue:o.captcha,"onUpdate:modelValue":e[0]||(e[0]=t=>o.captcha=t),hairline:"",mode:"line",maxlength:6,fontSize:"42rpx",color:"#333333",focus:!0,onFinish:a.finish},null,8,["modelValue","onFinish"]),C(h,{class:"u-m-t-40",style:{"font-size":"24rpx",color:"#666E81"}},{default:m((()=>[C(d,{ref:"uCode",seconds:o.limitSeconds,changeText:"Xs 后可重新获取",onChange:a.codeChange,onEnd:a.codeEnd},null,8,["seconds","onChange","onEnd"]),o.canSend?(S(),p(h,{key:0,style:{color:"#2647FF"}},{default:m((()=>[k("重发短信验证码")])),_:1})):(S(),p(h,{key:1},{default:m((()=>[k(w(o.codeText),1)])),_:1}))])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-b16f6b6b"]]);export{I as default};
